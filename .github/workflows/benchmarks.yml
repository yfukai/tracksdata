name: Benchmarks

on:
  pull_request:
    branches: [ main ]

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Fetch main branch
        run: git fetch origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install benchmarking tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install asv virtualenv

      - name: Cache ASV environments
        uses: actions/cache@v4
        with:
          path: .asv/env
          key: asv-env-${{ runner.os }}-py312-${{ hashFiles('pyproject.toml', 'asv.conf.json') }}
          restore-keys: |
            asv-env-${{ runner.os }}-py312-

      - name: Register ASV machine profile
        run: |
          asv machine \
            --yes \
            --machine github-actions \

      - name: Run ASV continuous benchmarks
        id: asv
        run: |
          set -o pipefail
          asv continuous origin/main HEAD \
            --machine github-actions \
            --python 3.12 \
            --show-stderr | tee asv-output.log
          tail -n 100 asv-output.log > asv-summary.txt
          {
            echo 'summary<<EOF'
            cat asv-summary.txt
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Publish ASV HTML
        run: asv publish

      - name: Upload ASV report
        uses: actions/upload-artifact@v4
        with:
          name: asv-html
          path: .asv/html
          if-no-files-found: warn

      - name: Find existing ASV comment
        if: github.event_name == 'pull_request'
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '### ASV Continuous Results'

      - name: Comment PR with ASV summary
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body: |
            ### ASV Continuous Results

            ```
            ${{ steps.asv.outputs.summary }}
            ```
          edit-mode: replace

      - name: Append benchmark summary
        run: |
          echo '### ASV Continuous Results' >> $GITHUB_STEP_SUMMARY
          cat asv-summary.txt >> $GITHUB_STEP_SUMMARY
