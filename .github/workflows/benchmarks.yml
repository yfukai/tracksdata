name: Benchmarks

on:
  pull_request:
    branches: [ main ]

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Fetch main branch
        run: git fetch origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install benchmarking tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install 'asv<0.6.2' virtualenv

      - name: Cache ASV environments
        uses: actions/cache@v4
        with:
          path: .asv/env
          key: asv-env-${{ runner.os }}-py312-${{ hashFiles('pyproject.toml', 'asv.conf.json') }}
          restore-keys: |
            asv-env-${{ runner.os }}-py312-

      - name: Register ASV machine profile
        run: |
          asv machine \
            --yes \
            --machine github-actions \
            --os "Ubuntu 22.04" \
            --arch "x86_64" \
            --cpu "GitHub-hosted runner" \
            --num_cpu "2" \
            --ram "7GB"

      - name: Run ASV continuous benchmarks
        run: |
          asv continuous origin/main HEAD \
            --machine github-actions \
            --python 3.12 \
            --show-stderr | tee asv-output.log

      - name: Publish ASV HTML
        run: asv publish

      - name: Upload ASV report
        uses: actions/upload-artifact@v4
        with:
          name: asv-html
          path: .asv/html
          if-no-files-found: warn

      - name: Append benchmark summary
        run: |
          echo '### ASV Continuous Results' >> $GITHUB_STEP_SUMMARY
          tail -n 100 asv-output.log >> $GITHUB_STEP_SUMMARY
